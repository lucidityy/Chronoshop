<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Webhook ChronoMedical - Solution Express.js</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        .url-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .url-input:focus {
            border-color: #667eea;
            outline: none;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-ok {
            background: #28a745;
            color: white;
        }
        .status-error {
            background: #dc3545;
            color: white;
        }
        .status-pending {
            background: #ffc107;
            color: black;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Webhook ChronoMedical</h1>
        <p class="subtitle">Solution Express.js - Fiable et Simple</p>
        
        <div class="test-section">
            <h3>üîß Configuration de l'URL du Webhook</h3>
            <p>Entrez l'URL de votre serveur webhook d√©ploy√© :</p>
            <input type="url" 
                   id="webhookUrl" 
                   class="url-input" 
                   placeholder="https://votre-webhook.onrender.com"
                   value="https://chronomedical-webhook.onrender.com">
            <button type="button" onclick="testConnectivity()">üîç Tester la Connectivit√©</button>
        </div>
        
        <div class="test-section">
            <h3>1. Test de Connectivit√© <span id="connectivity-status" class="status-badge status-pending">En attente</span></h3>
            <p>V√©rifiez que votre serveur webhook r√©pond :</p>
            <button type="button" onclick="testConnectivity()">üåê Test /api/test</button>
            <button type="button" onclick="testOrdersEndpoint()">üì¶ Test /api/orders</button>
        </div>
        
        <div class="test-section">
            <h3>2. Test d'une Commande Simul√©e <span id="order-status" class="status-badge status-pending">En attente</span></h3>
            <p>Envoyez une commande de test au webhook :</p>
            <button type="button" onclick="testOrder()">üì¶ Envoyer Commande Test</button>
        </div>
        
        <div class="test-section">
            <h3>3. Simuler un Message Bot <span id="bot-status" class="status-badge status-pending">En attente</span></h3>
            <p>Testez la r√©ponse du webhook √† un num√©ro de commande :</p>
            <input type="text" id="orderRef" placeholder="CM-TEST-123" value="">
            <button type="button" onclick="testBot()">ü§ñ Simuler Message Bot</button>
        </div>
        
        <div class="test-section">
            <h3>4. Test Bot Telegram R√©el</h3>
            <p>Testez directement avec le vrai bot :</p>
            <button type="button" onclick="openBot()">üîó Ouvrir @ChronoShopBot</button>
            <button type="button" onclick="checkWebhookConfig()">‚öôÔ∏è V√©rifier Config Webhook</button>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        let WEBHOOK_URL = '';
        
        function getWebhookUrl() {
            const input = document.getElementById('webhookUrl');
            WEBHOOK_URL = input.value.trim();
            if (!WEBHOOK_URL) {
                showResult('error', '‚ùå Veuillez entrer une URL de webhook valide');
                return false;
            }
            if (!WEBHOOK_URL.startsWith('http')) {
                WEBHOOK_URL = 'https://' + WEBHOOK_URL;
                input.value = WEBHOOK_URL;
            }
            return true;
        }
        
        function showResult(type, message) {
            const result = document.getElementById('result');
            result.className = `result ${type}`;
            result.innerHTML = message;
        }
        
        function updateStatus(statusId, status) {
            const element = document.getElementById(statusId);
            element.className = `status-badge status-${status}`;
            element.textContent = status === 'ok' ? 'OK' : status === 'error' ? 'Erreur' : 'En attente';
        }
        
        async function testConnectivity() {
            if (!getWebhookUrl()) return;
            
            showResult('warning', 'Test de connectivit√© en cours...');
            updateStatus('connectivity-status', 'pending');
            
            try {
                const response = await fetch(`${WEBHOOK_URL}/api/test`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('success', `‚úÖ Serveur webhook accessible !
                    
URL: ${WEBHOOK_URL}
Statut: ${response.status}
R√©ponse: ${JSON.stringify(data, null, 2)}`);
                    updateStatus('connectivity-status', 'ok');
                } else {
                    showResult('error', `‚ùå Erreur HTTP ${response.status}: ${JSON.stringify(data)}`);
                    updateStatus('connectivity-status', 'error');
                }
            } catch (error) {
                showResult('error', `‚ùå Erreur de connexion: ${error.message}
                
V√©rifiez que l'URL est correcte et que le serveur est d√©ploy√©.`);
                updateStatus('connectivity-status', 'error');
            }
        }
        
        async function testOrdersEndpoint() {
            if (!getWebhookUrl()) return;
            
            showResult('warning', 'Test de l\'endpoint orders...');
            
            try {
                const response = await fetch(`${WEBHOOK_URL}/api/orders`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('success', `‚úÖ Endpoint orders fonctionnel !
                    
${JSON.stringify(data, null, 2)}`);
                } else {
                    showResult('error', `‚ùå Erreur endpoint orders: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                showResult('error', `‚ùå Erreur endpoint orders: ${error.message}`);
            }
        }
        
        async function testOrder() {
            if (!getWebhookUrl()) return;
            
            const orderRef = 'CM-TEST-' + Date.now();
            document.getElementById('orderRef').value = orderRef;
            
            showResult('warning', 'Envoi de la commande test...');
            updateStatus('order-status', 'pending');
            
            const testOrderData = {
                orderRef: orderRef,
                items: [
                    { name: 'Aspirine', quantity: 2, price: 5.99 },
                    { name: 'Parac√©tamol', quantity: 1, price: 3.99 }
                ],
                total: 15.97,
                telegram: '@testuser',
                phone: '+33123456789',
                email: 'test@example.com',
                deliveryType: 'home',
                address: '123 Rue de Test, 75001 Paris'
            };
            
            try {
                const response = await fetch(`${WEBHOOK_URL}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testOrderData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('success', `‚úÖ Commande envoy√©e avec succ√®s !
                    
R√©f√©rence: ${orderRef}
R√©ponse: ${JSON.stringify(data, null, 2)}

üéØ √âtape suivante: Testez avec le bot en envoyant: ${orderRef}`);
                    updateStatus('order-status', 'ok');
                } else {
                    showResult('error', `‚ùå Erreur lors de l'envoi: ${JSON.stringify(data, null, 2)}`);
                    updateStatus('order-status', 'error');
                }
            } catch (error) {
                showResult('error', `‚ùå Erreur de connexion: ${error.message}`);
                updateStatus('order-status', 'error');
            }
        }
        
        async function testBot() {
            if (!getWebhookUrl()) return;
            
            const orderRef = document.getElementById('orderRef').value.trim();
            
            if (!orderRef) {
                showResult('error', '‚ùå Veuillez entrer un num√©ro de commande');
                return;
            }
            
            showResult('warning', 'Simulation du message bot...');
            updateStatus('bot-status', 'pending');
            
            const testMessage = {
                message: {
                    chat: { id: 123456789 },
                    from: { username: 'testuser' },
                    text: orderRef
                }
            };
            
            try {
                const response = await fetch(`${WEBHOOK_URL}/api/webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testMessage)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('success', `‚úÖ Message envoy√© au webhook !
                    
R√©f√©rence test√©e: ${orderRef}
Statut: ${response.status}
R√©ponse: ${JSON.stringify(data, null, 2)}

‚ÑπÔ∏è V√©rifiez les logs de votre serveur pour voir si la r√©ponse Telegram a √©t√© envoy√©e.`);
                    updateStatus('bot-status', 'ok');
                } else {
                    showResult('error', `‚ùå Erreur webhook: ${response.status}`);
                    updateStatus('bot-status', 'error');
                }
            } catch (error) {
                showResult('error', `‚ùå Erreur de connexion: ${error.message}`);
                updateStatus('bot-status', 'error');
            }
        }
        
        function openBot() {
            window.open('https://t.me/ChronoShopBot', '_blank');
        }
        
        async function checkWebhookConfig() {
            showResult('warning', 'V√©rification de la configuration webhook Telegram...');
            
            try {
                const response = await fetch('https://api.telegram.org/bot7576637364:AAHc904cJr58hHy3neSLimEMLGHtBxQ9JpA/getWebhookInfo');
                const data = await response.json();
                
                if (data.ok) {
                    const info = data.result;
                    showResult('success', `‚úÖ Configuration webhook Telegram:
                    
URL configur√©e: ${info.url || 'Aucune'}
Certificat: ${info.has_custom_certificate ? 'Oui' : 'Non'}
Erreurs en attente: ${info.pending_update_count || 0}
Derni√®re erreur: ${info.last_error_message || 'Aucune'}
Derni√®re erreur le: ${info.last_error_date ? new Date(info.last_error_date * 1000).toLocaleString() : 'Jamais'}
Tentatives max: ${info.max_connections || 'N/A'}

${info.url ? 'üéØ Le webhook est configur√© !' : '‚ö†Ô∏è Aucun webhook configur√©'}`);
                } else {
                    showResult('error', `‚ùå Erreur API Telegram: ${data.description}`);
                }
            } catch (error) {
                showResult('error', `‚ùå Erreur v√©rification webhook: ${error.message}`);
            }
        }
        
        // Test automatique au chargement
        window.addEventListener('load', () => {
            const urlInput = document.getElementById('webhookUrl');
            if (urlInput.value) {
                setTimeout(testConnectivity, 1000);
            }
        });
    </script>
</body>
</html> 